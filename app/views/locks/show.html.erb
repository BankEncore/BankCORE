<% content_for :title, "Session Locked" %>

<div class="card bg-base-100 border border-base-300 w-full max-w-md">
  <div class="card-body">
    <h1 class="card-title text-xl">Session Locked</h1>
    <p class="text-sm text-slate-600 mt-1">
      <%= Current.user&.display_label || "—" %> • Locked <%= @locked_at.is_a?(Time) ? l(@locked_at, format: :locked) : @locked_at %>
      <% if @locked_at.is_a?(Time) %>
        <br/><span class="text-slate-500">(<%= time_ago_in_words(@locked_at) %> ago)</span><hr/>
      <% end %>
    </p>
    <% if current_branch.present? || current_workstation.present? %>
      <p class="text-xs text-slate-500 mt-1">
        <% if current_branch.present? %>Branch: <%= current_branch.name %><% end %>
        <% if current_workstation.present? %> • Workstation: <%= current_workstation.name %><% end %>
      </p>
    <% end %>
    <% if current_teller_session.present? %>
      <p class="text-xs text-slate-500">Teller session: <%= current_teller_session.open? ? "Open" : "Closed" %></p>
    <% end %>

    <% if @error.present? %>
      <div class="alert alert-error mt-4 text-sm"><%= @error %></div>
    <% end %>

    <%= form_with url: lock_path, method: :patch, local: true, class: "mt-4", data: { action: "submit->session-lock#unlockWithFetch" } do |f| %>
      <div role="tablist" class="tabs tabs-boxed mb-4">
        <button type="button" role="tab" class="tab tab-active unlock-tab-teller">Teller Number & PIN</button>
        <button type="button" role="tab" class="tab unlock-tab-email">Email & Password</button>
      </div>

      <div id="unlock-teller-panel" class="unlock-panel">
        <div class="form-control">
          <%= f.label :teller_number, "Teller Number", class: "label" %>
          <%= f.text_field :teller_number, class: "input input-bordered", maxlength: 4, placeholder: "e.g. 002", autocomplete: "off" %>
        </div>
        <div class="form-control mt-2">
          <%= f.label :pin, "PIN", class: "label" %>
          <%= f.password_field :pin, class: "input input-bordered", inputmode: "numeric", autocomplete: "off" %>
        </div>
      </div>

      <div id="unlock-email-panel" class="unlock-panel hidden">
        <div class="form-control">
          <%= f.label :email_address, "Email", class: "label" %>
          <%= f.email_field :email_address, class: "input input-bordered", autocomplete: "email" %>
        </div>
        <div class="form-control mt-2">
          <%= f.label :password, "Password", class: "label" %>
          <%= f.password_field :password, class: "input input-bordered", autocomplete: "current-password" %>
        </div>
      </div>

      <div class="flex gap-2 mt-6">
        <%= f.submit "Unlock", class: "btn btn-primary" %>
        <%= link_to "Log out", session_path, data: { turbo_method: :delete }, class: "btn btn-ghost" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const tellerTab = document.querySelector(".unlock-tab-teller");
    const emailTab = document.querySelector(".unlock-tab-email");
    const tellerPanel = document.getElementById("unlock-teller-panel");
    const emailPanel = document.getElementById("unlock-email-panel");

    function showTeller() {
      tellerTab.classList.add("tab-active");
      emailTab.classList.remove("tab-active");
      tellerPanel.classList.remove("hidden");
      emailPanel.classList.add("hidden");
      tellerPanel.querySelector("input")?.focus();
    }

    function showEmail() {
      emailTab.classList.add("tab-active");
      tellerTab.classList.remove("tab-active");
      emailPanel.classList.remove("hidden");
      tellerPanel.classList.add("hidden");
      emailPanel.querySelector("input")?.focus();
    }

    tellerTab?.addEventListener("click", showTeller);
    emailTab?.addEventListener("click", showEmail);
  });
</script>

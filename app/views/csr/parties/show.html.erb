<%= render "csr/shared/record_screen" do %>

  <%= render "csr/shared/record_header",
    title: @party.display_name.presence || "Party ##{@party.id}",
    subtitle: "#{@party.party_kind.titleize} • #{@party.relationship_kind.titleize}",
    status: (@party.is_active? ? "Active" : "Inactive") do %>
    <%= link_to "Back to Parties", csr_parties_path, class: "btn btn-sm btn-ghost" %>
    <%= link_to "Edit", edit_csr_party_path(@party), class: "btn btn-sm btn-primary" %>
  <% end %>

  <div role="tablist" class="tabs tabs-boxed mb-4">
    <%= link_to "Details", csr_party_path(@party), role: "tab", class: "tab tab-active" %>
    <%= link_to "Advisories", csr_party_advisories_path(@party), role: "tab", class: "tab" %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <%= render "csr/shared/panel", title: "Contact" do %>
      <dl class="divide-y divide-base-300/60 text-sm">
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Display name</dt>
          <dd><%= @party.display_name.presence || "—" %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70"><%= @party.organization? ? "DBA name" : "DOB" %></dt>
          <dd>
            <% if @party.organization? %>
              <%= @party.party_organization&.dba_name.presence || "—" %>
            <% else %>
              <%= @party.party_individual&.dob&.strftime("%Y-%m-%d") || "—" %>
            <% end %>
          </dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Phone</dt>
          <dd><%= format_phone(@party.phone) %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Email</dt>
          <dd><%= @party.email.presence || "—" %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Address</dt>
          <dd>
            <% addr = [ @party.street_address, [ @party.city, @party.state ].compact_blank.join(", "), @party.zip_code ].compact_blank %>
            <%= addr.any? ? addr.join(", ") : "—" %>
          </dd>
        </div>
      </dl>
    <% end %>

    <%= render "csr/shared/panel", title: "Record" do %>
      <dl class="divide-y divide-base-300/60 text-sm">
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Relationship</dt>
          <dd><%= @party.relationship_kind.titleize %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Status</dt>
          <dd><%= @party.is_active? ? "Active" : "Inactive" %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Tax ID</dt>
          <dd class="font-mono tabular-nums"><%= mask_last_four(@party.tax_id) %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Government ID</dt>
          <dd class="font-mono tabular-nums"><%= mask_last_four(@party.party_individual&.govt_id) %></dd>
        </div>
      </dl>
    <% end %>
  </div>

  <% accounts = @party.accounts %>
  <%= render "csr/shared/panel", title: "Accounts", right: link_to("Add", new_csr_account_path(party_id: @party.id), class: "btn btn-primary btn-xs") do %>
    <% if accounts.any? %>
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Account</th>
              <th>Type</th>
              <th>Branch</th>
              <th>Status</th>
              <th class="text-right">Balance</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% accounts.each do |account| %>
              <% balance_cents = account.balance_cents %>
              <tr class="hover">
                <td class="font-mono tabular-nums"><%= account.account_number %></td>
                <td><%= account.account_type.titleize %></td>
                <td><%= account.branch.name %></td>
                <td><span class="badge badge-outline"><%= account.status %></span></td>
                <td class="text-right font-mono tabular-nums <%= balance_cents.negative? ? 'text-error' : 'text-success' %>"><%= number_to_currency(balance_cents / 100.0) %></td>
                <td class="text-right">
                  <%= link_to "View", csr_account_path(account), class: "btn btn-ghost btn-xs" %>
                  <%= link_to "Edit", edit_csr_account_path(account), class: "btn btn-ghost btn-xs" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-sm text-base-content/70">No accounts yet.</p>
    <% end %>
  <% end %>

  <% related = @party.related_parties %>
  <% if related.any? %>
    <%= render "csr/shared/panel", title: "Related parties" do %>
      <p class="text-sm text-base-content/70 mb-2">Parties with jointly owned accounts.</p>
      <ul class="space-y-1">
        <% related.each do |rp| %>
          <li><%= link_to rp.display_name.presence || "Party ##{rp.id}", csr_party_path(rp), class: "link" %></li>
        <% end %>
      </ul>
    <% end %>
  <% end %>

<% end %>

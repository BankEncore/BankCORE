<%= render "csr/shared/record_screen" do %>

  <div class="no-print">
    <%= render "csr/shared/record_header",
      title: "Account #{@account.account_number}",
      subtitle: "#{@account.account_type.titleize} • #{@account.branch.name}",
      status: @account.status do %>
      <%= link_to "Back to Accounts", csr_accounts_path, class: "btn btn-sm btn-ghost" %>
      <%= link_to "Edit", edit_csr_account_path(@account), class: "btn btn-sm btn-primary" %>
      <button type="button" onclick="window.print()" class="btn btn-outline btn-sm">Print</button>
    <% end %>
  </div>

  <div class="print-only mb-4">
    <h1 class="text-lg font-bold">BankCORE</h1>
    <p class="text-sm">Account Details — <%= mask_account_number(@account.account_number) %></p>
    <p class="text-xs text-slate-600"><%= @account.account_type.titleize %> • <%= @account.branch.name %> • <%= @account.status %></p>
  </div>

  <% primary = @account.primary_owner %>
  <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
    <%= render "csr/shared/panel", title: "Primary Owner", class: "md:col-span-5" do %>
      <% if primary %>
        <p class="font-medium"><%= link_to primary.display_name.presence || "Party ##{primary.id}", csr_party_path(primary), class: "link" %></p>
        <% addr = [ primary.street_address, [ primary.city, primary.state ].compact_blank.join(", "), primary.zip_code ].compact_blank %>
        <% if addr.any? %>
          <p class="text-sm text-base-content/70 mt-2 whitespace-pre-line"><%= addr.join("\n") %></p>
        <% end %>
      <% else %>
        <p class="text-base-content/70">—</p>
      <% end %>
    <% end %>

    <%= render "csr/shared/panel", title: "Account", class: "md:col-span-5" do %>
      <dl class="divide-y divide-base-300/60 text-sm">
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Account number</dt>
          <dd class="font-mono tabular-nums"><%= mask_account_number(@account.account_number) %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Type</dt>
          <dd><%= @account.account_type.titleize %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Branch</dt>
          <dd><%= @account.branch.name %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Status</dt>
          <dd><span class="badge badge-outline"><%= @account.status %></span></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Opened</dt>
          <dd class="tabular-nums"><%= @account.opened_on&.strftime("%Y-%m-%d") || "—" %></dd>
        </div>
        <div class="flex justify-between py-2">
          <dt class="text-base-content/70">Closed</dt>
          <dd class="tabular-nums"><%= @account.closed_on&.strftime("%Y-%m-%d") || "—" %></dd>
        </div>
      </dl>
    <% end %>

    <%= render "shared/accounts/balance_and_history", account: @account, account_transactions: @account_transactions, sections: [:balance], compact: true %>
  </div>

  <%= render "csr/shared/panel", title: "Owners", right: (raw("#{@account.account_owners.size} total ") + link_to("Add owner", "#add-owner-form", class: "no-print btn btn-primary btn-xs")) do %>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="row-border t-head">
            <th class="py-2 text-left">Party</th>
            <th class="py-2 text-left">Primary</th>
            <th class="no-print py-2 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @account.owners_ordered.each do |ao| %>
            <tr class="row-border">
              <td class="py-2"><%= link_to ao.party.display_name.presence || "Party ##{ao.party_id}", csr_party_path(ao.party), class: "link link-hover" %></td>
              <td class="py-2">
                <% if ao.is_primary? %>
                  <span class="badge badge-outline">Primary</span>
                <% else %>
                  <span class="no-print">
                    <%= button_to "Set as primary",
                          csr_account_account_owner_path(@account, ao),
                          method: :patch,
                          params: { account_owner: { is_primary: true } },
                          class: "btn btn-ghost btn-sm" %>
                  </span>
                  <span class="print-only">—</span>
                <% end %>
              </td>
              <td class="no-print py-2 text-right">
                <%= link_to "Edit", edit_csr_party_path(ao.party), class: "btn btn-ghost btn-sm" %>
                <% if @account.account_owners.size > 1 %>
                  <%= button_to "Remove",
                        csr_account_account_owner_path(@account, ao),
                        method: :delete,
                        form: { data: { turbo_confirm: "Remove this owner?" } },
                        class: "btn btn-ghost btn-sm text-error" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @parties_for_owner&.any? %>
      <%= form_with scope: :account_owner, url: csr_account_account_owners_path(@account), method: :post, local: true, class: "no-print mt-4 pt-4 border-t border-base-300/60 flex flex-wrap items-end gap-3", id: "add-owner-form" do |f| %>
        <div class="form-control">
          <%= f.label :party_id, "Add owner", class: "label label-text" %>
          <%= f.select :party_id,
                options_from_collection_for_select(@parties_for_owner, :id, :display_name),
                { include_blank: "Select party…" },
                class: "select select-bordered select-sm",
                required: true %>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer gap-2">
            <%= f.check_box :is_primary, class: "checkbox checkbox-sm" %>
            <span class="label-text">Primary</span>
          </label>
        </div>
        <%= f.submit "Add", class: "btn btn-primary btn-sm" %>
      <% end %>
    <% elsif @parties_for_owner.present? %>
      <p class="no-print mt-4 pt-4 border-t border-base-300/60 text-sm text-base-content/60">All eligible parties are already owners.</p>
    <% end %>
  <% end %>

  <%= render "shared/accounts/balance_and_history",
    account: @account,
    account_transactions: @account_transactions,
    sections: [:history],
    history_form_url: csr_account_path(@account),
    history_filter_params: params.permit(:date_from, :date_to, :amount_min, :amount_max, :sort, :sort_dir, transaction_types: []).to_h %>

<% end %>

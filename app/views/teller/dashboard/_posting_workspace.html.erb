<div id="posting-workspace"
  data-controller="posting-form line-items reference-panel approval-panel tx-shell tx-keyboard tx-validation tx-posting"
  data-action="tx:changed->posting-form#recalculate tx:recalc->reference-panel#refresh tx:recalc->tx-shell#handleRecalc tx:validate-requested->tx-validation#handleValidateRequested tx:post-requested->tx-posting#handlePostRequested tx:submit-requested->tx-shell#handleSubmitRequested tx:cancel-requested->tx-shell#handleCancelRequested tx:approval-required->approval-panel#show tx:approval-required->tx-shell#handleApprovalRequired tx:approval-cleared->approval-panel#hide tx:approval-cleared->tx-shell#handleApprovalCleared tx:approval-granted->posting-form#handleApprovalGranted tx:approval-granted->tx-shell#handleApprovalGranted tx:approval-error->posting-form#handleApprovalError tx:approval-error->tx-shell#handleApprovalError tx:posting-started->tx-shell#handlePostingStarted tx:posted-success->tx-shell#handlePostedSuccess tx:posted-failed->tx-shell#handlePostedFailed"
  data-posting-form-opening-cash-cents-value="<%= teller_session.opening_cash_cents %>"
  data-posting-form-default-transaction-type-value="<%= local_assigns.fetch(:default_transaction_type, "deposit") %>"
  data-posting-form-validate-url-value="<%= teller_validate_transaction_path %>"
  data-posting-form-account-reference-url-value="<%= teller_account_reference_path %>"
  data-posting-form-account-history-url-value="<%= teller_account_history_path %>"
  data-posting-form-workflow-schema-url-value="<%= teller_workflow_schema_path %>"
  data-posting-form-receipt-url-template-value="<%= teller_receipt_path(request_id: "__REQUEST_ID__") %>"
  data-approval-panel-approval-url-value="<%= teller_approvals_path %>"
  data-reference-panel-account-reference-url-value="<%= teller_account_reference_path %>"
  data-reference-panel-account-history-url-value="<%= teller_account_history_path %>">
  <% fixed_flow = !local_assigns.fetch(:show_transaction_type, true) %>
  <% flow_type = local_assigns.fetch(:default_transaction_type, "deposit") %>
  <% show_counterparty = fixed_flow && flow_type == "transfer" %>
  <% show_cash_account = local_assigns.fetch(:show_transaction_type, true) %>
  <% show_checks = fixed_flow && flow_type == "deposit" %>
  <% show_vault_transfer = fixed_flow && flow_type == "vault_transfer" %>
  <% show_draft = fixed_flow && flow_type == "draft" %>
  <% show_check_cashing = fixed_flow && flow_type == "check_cashing" %>
  <% cash_account_reference_value = teller_session.cash_location.present? ? "cash:#{teller_session.cash_location.code}" : "" %>
  <% cash_locations = Array(local_assigns.fetch(:cash_locations, [])).compact %>

  <%= form_with url: local_assigns.fetch(:form_url, teller_posting_path), method: :post, html: { id: "posting-form", data: { action: "submit->posting-form#submit" } } do |form| %>
    <p class="alert alert-info hidden" data-posting-form-target="message" aria-live="polite" hidden></p>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section aria-label="Entry Panel" class="card bg-base-100 border border-base-300 lg:col-span-2">
        <div class="card-body">
          <h2 class="card-title text-lg">Transaction Entry Panel</h2>
          <% if local_assigns.fetch(:show_transaction_type, true) %>
            <p class="form-control">
              <%= form.label :transaction_type, "Transaction Type" %><br>
              <%= form.select :transaction_type,
                options_for_select([["Deposit", "deposit"], ["Withdrawal", "withdrawal"], ["Transfer", "transfer"], ["Vault Transfer", "vault_transfer"], ["Bank Draft", "draft"], ["Check Cashing", "check_cashing"]]),
                {},
                { data: { posting_form_target: "transactionType", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
            </p>
          <% else %>
            <%= hidden_field_tag :transaction_type,
              local_assigns.fetch(:default_transaction_type, "deposit"),
              data: { posting_form_target: "transactionType" } %>
            <p><strong>Transaction Type:</strong> <%= local_assigns.fetch(:default_transaction_type, "deposit").titleize %></p>
          <% end %>

          <p class="form-control">
            <%= form.label :amount_cents, "Cash Amount" %><br>
            <%= form.number_field :amount_cents, min: 0, step: 1, value: 0, data: { posting_form_target: "amountCents", action: "input->posting-form#recalculate" }, required: true, class: "input input-bordered" %>
          </p>

          <p class="form-control">
            <%= form.label :primary_account_reference, "Primary Account Reference" %><br>
            <%= form.text_field :primary_account_reference, data: { posting_form_target: "primaryAccountReference", action: "input->posting-form#recalculate" }, required: true, class: "input input-bordered" %>
          </p>

          <p class="form-control" data-posting-form-target="counterpartyRow" <%= "hidden" unless show_counterparty %>>
            <%= form.label :counterparty_account_reference, "Counterparty Account Reference" %><br>
            <%= form.text_field :counterparty_account_reference, data: { posting_form_target: "counterpartyAccountReference", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
          </p>

          <% if show_cash_account %>
            <p class="form-control" data-posting-form-target="cashAccountRow" hidden>
              <%= form.label :cash_account_reference, "Cash Account Reference" %><br>
              <%= form.text_field :cash_account_reference,
                value: cash_account_reference_value,
                data: { posting_form_target: "cashAccountReference", action: "input->posting-form#recalculate" },
                class: "input input-bordered" %>
            </p>
          <% else %>
            <%= form.hidden_field :cash_account_reference,
              value: cash_account_reference_value,
              data: { posting_form_target: "cashAccountReference" } %>
          <% end %>

          <section data-posting-form-target="checkSection" <%= "hidden" unless show_checks %>>
            <div class="divider my-3"></div>
            <div class="flex items-center justify-between">
              <div class="font-medium">Checks</div>
              <button type="button" class="btn btn-sm btn-outline" data-action="line-items#addCheckRow">+ Add Check</button>
            </div>
            <div class="mt-3 space-y-3" data-posting-form-target="checkRows" data-line-items-target="checkRows"></div>
            <template data-posting-form-target="checkTemplate" data-line-items-target="checkTemplate">
              <div class="card bg-base-100 border border-base-300" data-check-row>
                <div class="card-body p-4">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input type="text" class="input input-bordered" placeholder="Routing #" data-check-field="routing" data-action="input->posting-form#recalculate">
                    <input type="text" class="input input-bordered" placeholder="Account #" data-check-field="account" data-action="input->posting-form#recalculate">
                    <input type="text" class="input input-bordered" placeholder="Check #" data-check-field="number" data-action="input->posting-form#recalculate">
                    <input type="number" min="1" step="1" class="input input-bordered" placeholder="Amount" data-check-field="amount" data-action="input->posting-form#recalculate">
                  </div>
                  <div class="mt-3 collapse collapse-arrow bg-base-200 border border-base-300">
                    <input type="checkbox">
                    <div class="collapse-title text-sm font-medium">Optional: Hold</div>
                    <div class="collapse-content">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select class="select select-bordered" data-check-field="holdReason">
                          <option value="">Hold reason (none)</option>
                          <option value="new_account">New Account</option>
                          <option value="large_item">Large Item</option>
                          <option value="exception">Exception</option>
                        </select>
                        <input type="date" class="input input-bordered" data-check-field="holdUntil">
                      </div>
                    </div>
                  </div>
                  <div class="mt-3 flex justify-end">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="line-items#removeCheckRow">Remove</button>
                  </div>
                </div>
              </div>
            </template>
          </section>

          <section data-posting-form-target="checkCashingSection" <%= "hidden" unless show_check_cashing %>>
            <div class="divider my-3"></div>
            <div class="font-medium">Check Cashing Details</div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <p class="form-control">
                <%= form.label :check_amount_cents, "Check Amount" %><br>
                <%= form.number_field :check_amount_cents, min: 1, step: 1, value: 0, data: { posting_form_target: "checkAmountCents", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :fee_cents, "Fee" %><br>
                <%= form.number_field :fee_cents, min: 0, step: 1, value: 0, data: { posting_form_target: "feeCents", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :settlement_account_reference, "Settlement Account Reference" %><br>
                <%= form.text_field :settlement_account_reference, data: { posting_form_target: "settlementAccountReference", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
              <p class="form-control">
                <%= form.label :check_number, "Check Number" %><br>
                <%= form.text_field :check_number, data: { posting_form_target: "checkNumber", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :payer_name, "Payer Name" %><br>
                <%= form.text_field :payer_name, data: { posting_form_target: "payerName", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :routing_number, "Routing Number" %><br>
                <%= form.text_field :routing_number, data: { posting_form_target: "routingNumber", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :account_number, "Account Number" %><br>
                <%= form.text_field :account_number, data: { posting_form_target: "accountNumber", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :presenter_type, "Presenter Type" %><br>
                <%= form.select :presenter_type,
                  options_for_select([["Customer", "customer"], ["Non-customer", "non_customer"]]),
                  {},
                  { data: { posting_form_target: "presenterType", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control">
                <%= form.label :id_type, "ID Type" %><br>
                <%= form.select :id_type,
                  options_for_select([["Driver's License", "drivers_license"], ["Passport", "passport"], ["State ID", "state_id"], ["Other", "other"]]),
                  {},
                  { data: { posting_form_target: "idType", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control md:col-span-2">
                <%= form.label :id_number, "ID Number" %><br>
                <%= form.text_field :id_number, data: { posting_form_target: "idNumber", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
            </div>

            <%= form.hidden_field :fee_income_account_reference,
              value: "income:check_cashing_fee",
              data: { posting_form_target: "feeIncomeAccountReference" } %>
          </section>

          <section data-posting-form-target="draftSection" <%= "hidden" unless show_draft %>>
            <div class="divider my-3"></div>
            <div class="font-medium">Bank Draft Details</div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <p class="form-control">
                <%= form.label :draft_funding_source, "Funding Source" %><br>
                <%= form.select :draft_funding_source,
                  options_for_select([["Account", "account"], ["Cash", "cash"]], "account"),
                  {},
                  { data: { posting_form_target: "draftFundingSource", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control">
                <%= form.label :draft_amount_cents, "Draft Amount" %><br>
                <%= form.number_field :draft_amount_cents, min: 1, step: 1, value: 0, data: { posting_form_target: "draftAmountCents", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :draft_fee_cents, "Fee" %><br>
                <%= form.number_field :draft_fee_cents, min: 0, step: 1, value: 0, data: { posting_form_target: "draftFeeCents", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control md:col-span-2">
                <%= form.label :draft_payee_name, "Payee" %><br>
                <%= form.text_field :draft_payee_name, data: { posting_form_target: "draftPayeeName", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
              <p class="form-control">
                <%= form.label :draft_instrument_number, "Instrument Number" %><br>
                <%= form.text_field :draft_instrument_number, data: { posting_form_target: "draftInstrumentNumber", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
            </div>

            <%= form.hidden_field :draft_liability_account_reference,
              value: "official_check:outstanding",
              data: { posting_form_target: "draftLiabilityAccountReference" } %>
            <%= form.hidden_field :draft_fee_income_account_reference,
              value: "income:draft_fee",
              data: { posting_form_target: "draftFeeIncomeAccountReference" } %>
          </section>

          <section data-posting-form-target="vaultTransferSection" <%= "hidden" unless show_vault_transfer %>>
            <div class="divider my-3"></div>
            <div class="font-medium">Vault Transfer Details</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              <p class="form-control">
                <%= form.label :vault_transfer_direction, "Direction" %><br>
                <%= form.select :vault_transfer_direction,
                  options_for_select([
                    ["Drawer → Vault", "drawer_to_vault"],
                    ["Vault → Drawer", "vault_to_drawer"],
                    ["Vault → Vault", "vault_to_vault"]
                  ], "drawer_to_vault"),
                  {},
                  { data: { posting_form_target: "vaultTransferDirection", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control" data-posting-form-target="vaultTransferCounterpartyRow">
                <%= form.label :vault_transfer_counterparty_reference, "Vault Cash Location" %><br>
                <%= form.select :vault_transfer_counterparty_reference,
                  options_for_select(cash_locations.map { |location| ["#{location.name} (#{location.code})", "cash:#{location.code}"] }),
                  { include_blank: "Select vault location" },
                  { data: { posting_form_target: "vaultTransferCounterpartyReference", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control" data-posting-form-target="vaultTransferSourceRow" hidden>
                <%= form.label :vault_transfer_source_cash_account_reference, "Source Vault" %><br>
                <%= form.select :vault_transfer_source_cash_account_reference,
                  options_for_select(cash_locations.map { |location| ["#{location.name} (#{location.code})", "cash:#{location.code}"] }),
                  { include_blank: "Select source vault" },
                  { data: { posting_form_target: "vaultTransferSourceReference", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control" data-posting-form-target="vaultTransferDestinationRow" hidden>
                <%= form.label :vault_transfer_destination_cash_account_reference, "Destination Vault" %><br>
                <%= form.select :vault_transfer_destination_cash_account_reference,
                  options_for_select(cash_locations.map { |location| ["#{location.name} (#{location.code})", "cash:#{location.code}"] }),
                  { include_blank: "Select destination vault" },
                  { data: { posting_form_target: "vaultTransferDestinationReference", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control">
                <%= form.label :vault_transfer_reason_code, "Reason Code" %><br>
                <%= form.select :vault_transfer_reason_code,
                  options_for_select([
                    ["Excess cash", "excess_cash"],
                    ["Replenish drawer", "replenish_drawer"],
                    ["End-of-day adjustment", "end_of_day_adjustment"],
                    ["Other", "other"]
                  ]),
                  { include_blank: "Select reason" },
                  { data: { posting_form_target: "vaultTransferReasonCode", action: "change->posting-form#recalculate" }, class: "select select-bordered w-full" } %>
              </p>
              <p class="form-control md:col-span-2">
                <%= form.label :vault_transfer_memo, "Memo" %><br>
                <%= form.text_field :vault_transfer_memo, data: { posting_form_target: "vaultTransferMemo", action: "input->posting-form#recalculate" }, class: "input input-bordered" %>
              </p>
            </div>
          </section>

          <%= form.hidden_field :request_id, value: "", data: { posting_form_target: "requestId" } %>
          <%= form.hidden_field :approval_token, value: "", data: { posting_form_target: "approvalToken" } %>
        </div>
      </section>

      <%= render "teller/shared/reference_panel", teller_session: teller_session %>
    </div>

    <%= render "teller/shared/totals_panel" %>

    <%= render "teller/shared/cash_footer" %>

    <%= render "teller/shared/approval_modal" %>

    <section aria-label="Receipt Confirmation" data-posting-form-target="receiptPanel" class="card bg-base-100 border border-base-300" hidden>
      <div class="card-body">
        <h2 class="card-title text-lg">Receipt Confirmation</h2>
        <p>Posting Batch ID: <strong data-posting-form-target="receiptBatchId">N/A</strong></p>
        <p>Teller Transaction ID: <strong data-posting-form-target="receiptTransactionId">N/A</strong></p>
        <p>Request ID: <strong data-posting-form-target="receiptRequestId">N/A</strong></p>
        <p>Posted At: <strong data-posting-form-target="receiptPostedAt">N/A</strong></p>
        <p>
          <a class="btn btn-outline btn-sm" data-posting-form-target="receiptLink" href="#" hidden>View Receipt / Audit</a>
          <button type="button" class="btn btn-primary btn-sm ml-2" data-posting-form-target="receiptNewButton" data-action="posting-form#startNewTransaction" hidden>New Transaction</button>
        </p>
      </div>
    </section>

    <section aria-label="Primary Action">
      <%= form.submit "Post Transaction", data: { posting_form_target: "submitButton" }, style: "display:none;" %>
    </section>
  <% end %>
</div>

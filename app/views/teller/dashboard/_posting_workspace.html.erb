<div class="posting-workspace">
  <% flow_type = local_assigns.fetch(:default_transaction_type, "deposit").presence || "deposit" %>
  <% workflow_form_controller = local_assigns.fetch(:workflow_form_controller, "#{flow_type.tr('_', '-')}-form") %>
  <% selected_party = local_assigns[:selected_party] %>
  <% cash_account_reference_value = teller_session.cash_location.present? ? "cash:#{teller_session.cash_location.code}" : "" %>
  <% cash_locations = Array(local_assigns.fetch(:cash_locations, [])).compact %>

  <%= form_with url: local_assigns.fetch(:form_url, teller_posting_path), method: :post, html: { id: "posting-form", data: { turbo: false, action: "submit->#{workflow_form_controller}#submit" } } do |form| %>
    <p class="alert alert-info hidden" data-<%= workflow_form_controller %>-target="message" aria-live="polite" hidden></p>

    <div class="mb-4" data-reference-panel-target="advisoriesContainer">
      <p class="text-xs opacity-70">Select an account to view advisories.</p>
      <div class="space-y-2 mt-2" hidden></div>
      <a href="#" class="text-xs link link-hover mt-2 block" hidden>View all advisories</a>
    </div>

    <div class="mb-4">
      <%= render "teller/shared/posting_readiness_strip", show_serve_previous_party: %w[deposit withdrawal transfer draft check_cashing misc_receipt].include?(flow_type) %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <div class="lg:col-span-8 space-y-4">
      <section aria-label="Entry Panel" class="card bg-base-100 border border-base-300">
        <div class="card-body">
          <% case flow_type %>
          <% when "deposit" %>
            <%= render "teller/forms/deposit_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% when "withdrawal" %>
            <%= render "teller/forms/withdrawal_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% when "transfer" %>
            <%= render "teller/forms/transfer_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% when "check_cashing" %>
            <%= render "teller/forms/check_cashing_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% when "draft" %>
            <%= render "teller/forms/draft_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% when "misc_receipt" %>
            <%= render "teller/forms/misc_receipt_form",
              form: form,
              selected_party: selected_party,
              cash_account_reference_value: cash_account_reference_value,
              misc_receipt_types: local_assigns[:misc_receipt_types] || [],
              workflow_form_controller: workflow_form_controller %>
          <% when "vault_transfer" %>
            <%= render "teller/forms/vault_transfer_form",
              form: form,
              cash_locations: cash_locations,
              workflow_form_controller: workflow_form_controller %>
          <% else %>
            <%= render "teller/forms/deposit_form",
              form: form,
              cash_account_reference_value: cash_account_reference_value,
              workflow_form_controller: workflow_form_controller %>
          <% end %>

          <%= form.hidden_field :request_id, value: "", "data-#{workflow_form_controller}-target" => "requestId", "data-posting-form-target" => "requestId" %>
          <%= form.hidden_field :approval_token, value: "", "data-#{workflow_form_controller}-target" => "approvalToken", "data-posting-form-target" => "approvalToken" %>
        </div>
      </section>

      <section aria-label="Posting Preview" class="card bg-base-100 border border-base-300" data-<%= workflow_form_controller %>-target="postingPreviewSection">
        <div class="card-body">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="card-title text-base">Posting Preview</h2>
              <p class="text-xs text-slate-600 mt-1">Ledger entries: debits and credits.</p>
            </div>
            <span class="badge badge-outline">Preview</span>
          </div>
          <div class="divider my-3"></div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="row-border t-head">
                  <th class="py-2 text-left">Leg</th>
                  <th class="py-2 text-left">GL Account</th>
                  <th class="py-2 text-right">Debit</th>
                  <th class="py-2 text-right">Credit</th>
                </tr>
              </thead>
              <tbody data-<%= workflow_form_controller %>-target="postingPreviewBody"></tbody>
            </table>
          </div>
          <p class="mt-3 text-xs text-slate-600" data-<%= workflow_form_controller %>-target="postingPreviewEmpty">Enter amounts to see posting preview.</p>
        </div>
      </section>
      </div>

      <aside class="lg:col-span-4 space-y-4">
        <%# Account Reference panel removed from posting screens; partial kept at teller/shared/_reference_panel.html.erb %>
        <%= render "teller/shared/live_account_panel" %>
        <%= render "teller/shared/funds_availability_panel", workflow_form_controller: workflow_form_controller %>
        <%# %= render "teller/shared/posting_readiness_panel" %>
        <%# drawer_totals removed from transaction screen; partial kept at teller/shared/_drawer_totals.html.erb %>
      </aside>
    </div>

    <section aria-label="Receipt Confirmation" data-<%= workflow_form_controller %>-target="receiptPanel" class="card bg-base-100 border border-base-300" hidden>
      <div class="card-body">
        <h2 class="card-title text-lg">Receipt Confirmation</h2>
        <p>Posting Batch ID: <strong data-<%= workflow_form_controller %>-target="receiptBatchId">N/A</strong></p>
        <p>Teller Transaction ID: <strong data-<%= workflow_form_controller %>-target="receiptTransactionId">N/A</strong></p>
        <p>Request ID: <strong data-<%= workflow_form_controller %>-target="receiptRequestId">N/A</strong></p>
        <p>Posted At: <strong data-<%= workflow_form_controller %>-target="receiptPostedAt">N/A</strong></p>
        <p>
          <a class="btn btn-outline btn-sm" data-<%= workflow_form_controller %>-target="receiptLink" href="#" hidden>View Receipt / Audit</a>
          <button type="button" class="btn btn-primary btn-sm ml-2" data-<%= workflow_form_controller %>-target="receiptNewButton" data-action="<%= workflow_form_controller %>#startNewTransaction" hidden>New Transaction</button>
        </p>
      </div>
    </section>

    <section aria-label="Primary Action">
      <%= form.submit "Post Transaction", data: { "#{workflow_form_controller}_target": "submitButton" }, style: "display:none;" %>
    </section>
  <% end %>

  <%= render "teller/shared/approval_modal" %>
  <%= render "teller/shared/advisory_modal" %>
  <%= render "teller/shared/post_success_modal", workflow_form_controller: workflow_form_controller %>
  <%= render "teller/shared/check_hold_modal" %>
</div>

<section class="card bg-base-100 border border-base-300">
  <div class="card-body">
    <h2 class="card-title text-lg">Teller Session</h2>
    <p>Status: <%= teller_session&.status || "Not open" %></p>
    <p>Drawer: <%= teller_session&.cash_location&.name || "Not assigned" %></p>
    <% money = ->(cents) { number_to_currency((cents || 0) / 100.0) } %>
    <% if teller_session.present? && teller_session.open? %>
      <p>Opening cash: <span class="ui-money"><%= money[teller_session.opening_cash_cents] %></span></p>
      <p>Net cash movements: <span class="ui-money"><%= money[teller_session.net_cash_movement_cents] %></span></p>
      <p>Expected cash now: <span class="ui-money"><%= money[teller_session.expected_cash_cents] %></span></p>
    <% elsif teller_session.present? && teller_session.closed? %>
      <p>Opening cash: <span class="ui-money"><%= money[teller_session.opening_cash_cents] %></span></p>
      <p>Expected closing cash: <span class="ui-money"><%= money[teller_session.expected_closing_cash_cents] %></span></p>
      <p>Declared closing cash: <span class="ui-money"><%= money[teller_session.closing_cash_cents] %></span></p>
      <p>Cash variance: <span class="ui-money"><%= money[teller_session.cash_variance_cents] %></span></p>
    <% end %>

    <% if teller_session.blank? %>
      <%= form_with url: teller_teller_session_path, method: :post do |form| %>
        <p class="form-control">
          <%= form.label :opening_cash_cents, "Opening cash" %><br>
          <div data-controller="currency-input">
            <%= form.hidden_field :opening_cash_cents, value: 0, data: { currency_input_target: "hiddenInput" } %>
            <input type="text" class="input input-bordered" inputmode="decimal" placeholder="$0.00" aria-label="Opening cash" data-currency-input-target="displayInput" data-action="input->currency-input#input blur->currency-input#blur" id="<%= form.field_id(:opening_cash_cents) %>" required />
          </div>
        </p>
        <%= form.submit "Open Teller Session", class: "btn btn-primary" %>
      <% end %>
    <% else %>
      <% if teller_session.cash_location.blank? %>
        <%= form_with url: assign_drawer_teller_teller_session_path, method: :patch do |form| %>
          <p class="form-control">
            <%= form.label :cash_location_id, "Assign drawer" %><br>
            <%= form.select :cash_location_id,
              options_from_collection_for_select(drawers, :id, :name),
              { include_blank: "Select drawer" },
              { required: true, class: "select select-bordered w-full" } %>
          </p>
          <%= form.submit "Assign Drawer", class: "btn btn-primary" %>
        <% end %>
      <% end %>

      <%= form_with url: close_teller_teller_session_path, method: :patch do |form| %>
        <p class="form-control">
          <%= form.label :closing_cash_cents, "Declared closing cash" %><br>
          <div data-controller="currency-input">
            <%= form.hidden_field :closing_cash_cents, value: 0, data: { currency_input_target: "hiddenInput" } %>
            <input type="text" class="input input-bordered" inputmode="decimal" placeholder="$0.00" aria-label="Declared closing cash" data-currency-input-target="displayInput" data-action="input->currency-input#input blur->currency-input#blur" id="<%= form.field_id(:closing_cash_cents) %>" required />
          </div>
        </p>
        <p class="form-control">
          <%= form.label :cash_variance_reason, "Variance reason (optional)" %><br>
          <%= form.text_field :cash_variance_reason, class: "input input-bordered" %>
        </p>
        <p class="form-control">
          <%= form.label :cash_variance_notes, "Variance notes (optional)" %><br>
          <%= form.text_area :cash_variance_notes, class: "textarea textarea-bordered", rows: 3 %>
        </p>
        <%= form.submit "Close Teller Session", class: "btn btn-warning" %>
      <% end %>
    <% end %>
  </div>
</section>

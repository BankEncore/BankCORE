<%= render "teller/shared/page_header",
  title: @party.display_name.presence || "Party ##{@party.id}",
  description: "#{@party.party_kind.titleize} • #{@party.relationship_kind.titleize}",
  secondary_button_path: teller_parties_path,
  secondary_button_label: "Back to Parties",
  primary_button_path: edit_teller_party_path(@party),
  primary_button_label: "Edit" %>

<div role="tablist" class="tabs tabs-boxed mb-4">
  <%= link_to "Details", teller_party_path(@party), role: "tab", class: "tab #{params[:tab] != 'advisories' ? 'tab-active' : ''}" %>
  <%= link_to "Advisories", teller_party_path(@party, tab: "advisories"), role: "tab", class: "tab #{params[:tab] == 'advisories' ? 'tab-active' : ''}" %>
</div>

<% if params[:tab] == "advisories" %>
  <%= render "teller/shared/advisories_tab",
    advisories: @advisories,
    scope_record: @party,
    advisories_path: teller_party_advisories_path(@party),
    new_advisory_path: new_teller_party_advisory_path(@party),
    can_create: policy([ :teller, Advisory ]).create? %>
<% else %>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <section class="card bg-base-100 border border-base-300">
    <div class="card-body">
      <h2 class="card-title text-base">Contact</h2>
      <div class="divider my-3"></div>
      <dl class="space-y-1">
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Display name</dt>
          <dd class="ui-kv-value text-sm"><%= @party.display_name.presence || "—" %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs"><%= @party.organization? ? "DBA name" : "DOB" %></dt>
          <dd class="ui-kv-value text-sm">
            <% if @party.organization? %>
              <%= @party.party_organization&.dba_name.presence || "—" %>
            <% else %>
              <%= @party.party_individual&.dob&.strftime("%Y-%m-%d") || "—" %>
            <% end %>
          </dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Phone</dt>
          <dd class="ui-kv-value text-sm"><%= format_phone(@party.phone) %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Email</dt>
          <dd class="ui-kv-value text-sm"><%= @party.email.presence || "—" %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Address</dt>
          <dd class="ui-kv-value text-sm">
            <% addr = [ @party.street_address, [ @party.city, @party.state ].compact_blank.join(", "), @party.zip_code ].compact_blank %>
            <%= addr.any? ? addr.join("\n") : "—" %>
          </dd>
        </div>
      </dl>
    </div>
  </section>

  <section class="card bg-base-100 border border-base-300">
    <div class="card-body">
      <h2 class="card-title text-base">Record</h2>
      <div class="divider my-3"></div>
      <dl class="space-y-1">
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Relationship</dt>
          <dd class="ui-kv-value text-sm"><%= @party.relationship_kind.titleize %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Status</dt>
          <dd class="ui-kv-value text-sm"><%= @party.is_active? ? "Active" : "Inactive" %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Tax ID</dt>
          <dd class="ui-kv-value text-sm font-mono"><%= mask_last_four(@party.tax_id) %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Government ID</dt>
          <dd class="ui-kv-value text-sm font-mono"><%= mask_last_four(@party.party_individual&.govt_id) %></dd>
        </div>
      </dl>
    </div>
  </section>
</div>

<section class="card bg-base-100 border border-base-300 mt-4">
  <div class="card-body">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h2 class="card-title text-base">Accounts</h2>
        <p class="text-xs text-slate-600 mt-1">Accounts owned by this party.</p>
      </div>
      <%= link_to "Add", new_teller_account_path(party_id: @party.id), class: "btn btn-primary btn-sm" %>
    </div>
    <div class="divider my-3"></div>
    <% accounts = @party.accounts %>
    <% if accounts.any? %>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="row-border t-head">
              <th class="py-2 text-left">Account</th>
              <th class="py-2 text-left">Type</th>
              <th class="py-2 text-left">Branch</th>
              <th class="py-2 text-left">Status</th>
              <th class="py-2 text-right">Balance</th>
              <th class="py-2 text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% accounts.each do |account| %>
              <% balance_cents = account.balance_cents %>
              <tr class="row-border">
                <td class="py-2 mono"><%= account.account_number %></td>
                <td class="py-2"><%= account.account_type %></td>
                <td class="py-2"><%= account.branch.name %></td>
                <td class="py-2"><span class="badge badge-outline"><%= account.status %></span></td>
                <td class="py-2 text-right mono tabular-nums <%= balance_cents.negative? ? 'text-error' : 'ui-money' %>"><%= number_to_currency(balance_cents / 100.0) %></td>
                <td class="py-2 text-right">
                  <%= link_to "View", teller_account_path(account), class: "btn btn-ghost btn-sm" %>
                  <%= link_to "Edit", edit_teller_account_path(account), class: "btn btn-ghost btn-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-sm text-slate-600">No accounts yet.</p>
    <% end %>
  </div>
</section>

<% related = @party.related_parties %>
<% if related.any? %>
  <section class="card bg-base-100 border border-base-300 mt-4">
    <div class="card-body">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="card-title text-base">Related parties</h2>
          <p class="text-xs text-slate-600 mt-1">Parties with jointly owned accounts.</p>
        </div>
      </div>
      <div class="divider my-3"></div>
      <ul class="space-y-1">
        <% related.each do |rp| %>
          <li><%= link_to rp.display_name.presence || "Party ##{rp.id}", teller_party_path(rp), class: "link link-hover" %></li>
        <% end %>
      </ul>
    </div>
  </section>
<% end %>
<% end %>

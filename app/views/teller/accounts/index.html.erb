<%= render "teller/shared/page_header",
  title: "Accounts",
  description: "Bank accounts by branch or party.",
  secondary_button_path: teller_root_path,
  secondary_button_label: "Back to Workspace",
  primary_button_path: new_teller_account_path(branch_id: current_branch&.id),
  primary_button_label: "New Account" %>

<% filter_params = params.permit(:q, :branch_id, :party_id, :account_type, :status, :per_page).to_h %>

<section class="card bg-base-100 border border-base-300">
  <div class="card-body">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h2 class="card-title text-base">Accounts</h2>
        <p class="text-xs text-slate-600 mt-1">Bank accounts by branch or party.</p>
      </div>
    </div>
    <div class="divider my-3"></div>

    <%= form_with url: teller_accounts_path, method: :get, local: true, class: "mb-4 space-y-3" do %>
      <%= hidden_field_tag :branch_id, params[:branch_id] %>
      <%= hidden_field_tag :party_id, params[:party_id] %>
      <%= hidden_field_tag :per_page, params[:per_page] %>
      <div class="flex flex-wrap gap-3 items-end">
        <div class="form-control">
          <%= label_tag :q, "Search", class: "text-xs font-medium text-slate-700" %>
          <%= text_field_tag :q, params[:q], class: "input input-bordered input-sm w-48", placeholder: "Account # or owner name" %>
        </div>
        <div class="form-control">
          <%= label_tag :account_type, "Type", class: "text-xs font-medium text-slate-700" %>
          <%= select_tag :account_type, options_for_select([ [ "All", "" ] ] + Account::ACCOUNT_TYPES.map { |t| [ t.titleize, t ] }, params[:account_type]), class: "select select-bordered select-sm" %>
        </div>
        <div class="form-control">
          <%= label_tag :status, "Status", class: "text-xs font-medium text-slate-700" %>
          <%= select_tag :status, options_for_select([ [ "All", "" ] ] + Account::STATUSES.map { |s| [ s.titleize, s ] }, params[:status]), class: "select select-bordered select-sm" %>
        </div>
        <%= submit_tag "Search", class: "btn btn-primary btn-sm" %>
        <%= link_to "Clear", teller_accounts_path(filter_params.except(:q, :account_type, :status)), class: "btn btn-ghost btn-sm" %>
      </div>
    <% end %>

    <div class="flex gap-2 flex-wrap mb-4">
      <%= link_to "All", teller_accounts_path(filter_params.except(:branch_id, :party_id)), class: "btn btn-sm #{params[:branch_id].blank? && params[:party_id].blank? ? 'btn-primary' : 'btn-ghost'}" %>
      <% if current_branch.present? %>
        <%= link_to "This branch", teller_accounts_path(filter_params.merge(branch_id: current_branch.id)), class: "btn btn-sm #{params[:branch_id].to_s == current_branch.id.to_s ? 'btn-primary' : 'btn-ghost'}" %>
      <% end %>
    </div>

    <div class="flex justify-between items-center mb-2">
      <span class="text-sm text-slate-600"><%= @pagy.count %> accounts</span>
      <% current_per = [ 10, 25, 50, 100 ].include?(params[:per_page].to_i) ? params[:per_page].to_i : 10 %>
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-600">Per page:</span>
        <% [ 10, 25, 50, 100 ].each do |n| %>
          <%= link_to n, teller_accounts_path(filter_params.merge(per_page: n, page: 1)), class: "btn btn-ghost btn-xs #{current_per == n ? 'btn-active' : ''}" %>
        <% end %>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="row-border t-head">
            <th class="py-2 text-left">Account</th>
            <th class="py-2 text-left">Type</th>
            <th class="py-2 text-left">Branch</th>
            <th class="py-2 text-left">Status</th>
            <th class="py-2 text-left">Owners</th>
            <th class="py-2 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @accounts.any? %>
            <% @accounts.each do |account| %>
              <tr class="row-border">
                <td class="py-2 mono"><%= mask_account_number(account.account_number) %></td>
                <td class="py-2"><%= account.account_type %></td>
                <td class="py-2"><%= account.branch.name %></td>
                <td class="py-2"><span class="badge badge-outline"><%= account.status %></span></td>
                <td class="py-2"><%= account.owners_ordered.map { |ao| ao.party.display_name }.compact.join(", ").presence || "â€”" %></td>
                <td class="py-2 text-right">
                  <%= link_to "View", teller_account_path(account), class: "btn btn-ghost btn-sm" %>
                  <%= link_to "Edit", edit_teller_account_path(account), class: "btn btn-ghost btn-sm" %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr class="row-border">
              <td colspan="6" class="py-4 text-center text-slate-600">No accounts found.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @pagy.pages > 1 %>
      <div class="mt-4 flex justify-center">
        <%== @pagy.series_nav %>
      </div>
    <% end %>
  </div>
</section>

<div class="no-print">
  <section aria-label="Page Header" class="card bg-base-100 border border-base-300">
    <div class="card-body py-3">
      <h2 class="card-title text-lg">Account <%= @account.account_number %></h2>
      <p class="text-sm opacity-80"><%= @account.account_type.titleize %> • <%= @account.branch.name %></p>
      <p class="flex gap-2">
        <%= link_to "Back to Accounts", teller_accounts_path, class: "btn btn-ghost btn-sm" %>
        <%= link_to "Edit", edit_teller_account_path(@account), class: "btn btn-primary btn-sm" %>
        <button type="button" onclick="window.print()" class="btn btn-outline btn-sm">Print</button>
      </p>
    </div>
  </section>
</div>

<div class="print-only mb-4">
  <h1 class="text-lg font-bold">BankCORE</h1>
  <p class="text-sm">Account Details — <%= mask_account_number(@account.account_number) %></p>
  <p class="text-xs text-slate-600"><%= @account.account_type.titleize %> • <%= @account.branch.name %> • <%= @account.status %></p>
</div>

<div role="tablist" class="tabs tabs-boxed mb-4 no-print">
  <%= link_to "Details", teller_account_path(@account), role: "tab", class: "tab #{params[:tab] != 'advisories' ? 'tab-active' : ''}" %>
  <%= link_to "Advisories", teller_account_path(@account, tab: "advisories"), role: "tab", class: "tab #{params[:tab] == 'advisories' ? 'tab-active' : ''}" %>
</div>

<% if params[:tab] == "advisories" %>
  <%= render "teller/shared/advisories_tab",
    advisories: @advisories,
    scope_record: @account,
    advisories_path: teller_account_advisories_path(@account),
    new_advisory_path: new_teller_account_advisory_path(@account),
    can_create: policy([ :teller, Advisory ]).create? %>
<% else %>
<% primary = @account.primary_owner %>
<div class="grid grid-cols-1 md:grid-cols-12 gap-4">
  <section class="card receipt-section bg-base-100 border border-base-300 md:col-span-5">
    <div class="card-body">
      <h2 class="card-title text-base">Primary Owner</h2>
      <div class="divider my-3"></div>
      <% if primary %>
        <p class="font-medium"><%= link_to primary.display_name.presence || "Party ##{primary.id}", teller_party_path(primary), class: "link link-hover" %></p>
        <% addr = [ primary.street_address, [ primary.city, primary.state ].compact_blank.join(", "), primary.zip_code ].compact_blank %>
        <% if addr.any? %>
          <p class="text-sm text-slate-600 mt-2 whitespace-pre-line"><%= addr.join("\n") %></p>
        <% end %>
      <% else %>
        <p class="text-slate-600">—</p>
      <% end %>
    </div>
  </section>

  <section class="card receipt-section bg-base-100 border border-base-300 md:col-span-5">
    <div class="card-body">
      <h2 class="card-title text-base">Account</h2>
      <div class="divider my-3"></div>
      <dl class="space-y-1">
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Account number</dt>
          <dd class="ui-kv-value text-sm mono"><%= mask_account_number(@account.account_number) %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Type</dt>
          <dd class="ui-kv-value text-sm"><%= @account.account_type.titleize %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Branch</dt>
          <dd class="ui-kv-value text-sm"><%= @account.branch.name %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Status</dt>
          <dd class="ui-kv-value text-sm"><span class="badge badge-outline"><%= @account.status %></span></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Opened</dt>
          <dd class="ui-kv-value text-sm mono"><%= @account.opened_on.strftime("%Y-%m-%d") %></dd>
        </div>
        <div class="ui-kv-row">
          <dt class="ui-kv-key text-xs">Closed</dt>
          <dd class="ui-kv-value text-sm mono"><%= @account.closed_on&.strftime("%Y-%m-%d") || "—" %></dd>
        </div>
      </dl>
    </div>
  </section>

  <%= render "shared/accounts/balance_and_history", account: @account, account_transactions: @account_transactions, sections: [:balance], compact: true %>
</div>

<section class="card receipt-section bg-base-100 border border-base-300 mt-4">
  <div class="card-body">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h2 class="card-title text-base">Owners</h2>
        <p class="text-xs text-slate-600 mt-1">Parties with ownership of this account.</p>
      </div>
      <% if @parties_for_owner&.any? %>
        <a href="#add-owner-form" class="no-print btn btn-primary btn-sm">Add owner</a>
      <% end %>
    </div>
    <div class="divider my-3"></div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="row-border t-head">
            <th class="py-2 text-left">Party</th>
            <th class="py-2 text-left">Primary</th>
            <th class="no-print py-2 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @account.owners_ordered.each do |ao| %>
            <tr class="row-border">
              <td class="py-2"><%= link_to ao.party.display_name.presence || "Party ##{ao.party_id}", teller_party_path(ao.party), class: "link link-hover" %></td>
              <td class="py-2">
                <% if ao.is_primary? %>
                  Yes
                <% else %>
                  <span class="no-print">
                    <%= button_to "Set as primary",
                          teller_account_account_owner_path(@account, ao),
                          method: :patch,
                          params: { account_owner: { is_primary: true } },
                          class: "btn btn-ghost btn-sm" %>
                  </span>
                  <span class="print-only">—</span>
                <% end %>
              </td>
              <td class="no-print py-2 text-right">
                <%= link_to "Edit", edit_teller_party_path(ao.party), class: "btn btn-ghost btn-sm" %>
                <% if @account.account_owners.size > 1 %>
                  <%= button_to "Remove",
                        teller_account_account_owner_path(@account, ao),
                        method: :delete,
                        form: { data: { turbo_confirm: "Remove this owner?" } },
                        class: "btn btn-ghost btn-sm text-error" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @parties_for_owner&.any? %>
      <%= form_with scope: :account_owner, url: teller_account_account_owners_path(@account), method: :post, local: true, class: "no-print mt-4 pt-4 border-t border-base-300 flex flex-wrap items-end gap-3", id: "add-owner-form" do |f| %>
        <div class="form-control">
          <%= f.label :party_id, "Add owner", class: "text-xs font-medium text-slate-700" %>
          <%= f.select :party_id,
                options_from_collection_for_select(@parties_for_owner, :id, :display_name),
                { include_blank: "Select party…" },
                class: "select select-bordered select-sm",
                required: true %>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer gap-2">
            <%= f.check_box :is_primary, class: "checkbox checkbox-sm" %>
            <span class="label-text text-sm">Primary</span>
          </label>
        </div>
        <%= f.submit "Add", class: "btn btn-primary btn-sm" %>
      <% end %>
    <% elsif @parties_for_owner.present? %>
      <p class="no-print mt-4 pt-4 border-t border-base-300 text-sm text-slate-600">All eligible parties are already owners.</p>
    <% end %>
  </div>
</section>

<%= render "shared/accounts/balance_and_history",
  account: @account,
  account_transactions: @account_transactions,
  sections: [:history],
  history_form_url: teller_account_path(@account),
  history_filter_params: params.permit(:date_from, :date_to, :amount_min, :amount_max, :sort, :sort_dir, transaction_types: []).to_h %>
<% end %>

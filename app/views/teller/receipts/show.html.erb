<div class="space-y-4">
  <div class="no-print">
    <section aria-label="Page Header" class="card bg-base-100 border border-base-300">
      <div class="card-body py-3">
        <h2 class="card-title text-lg">Receipt / Audit</h2>
        <p class="text-sm opacity-80">Posted transaction details (immutable)</p>
        <p class="flex gap-2">
          <%= link_to "Back to Dashboard", teller_root_path, class: "btn btn-ghost btn-sm" %>
          <button type="button" onclick="window.print()" class="btn btn-outline btn-sm">Print</button>
        </p>
      </div>
    </section>
  </div>

  <div class="print-only mb-4">
    <h1 class="text-lg font-bold">BankCORE</h1>
    <p class="text-sm"><%= @teller_transaction.transaction_type.titleize %> Receipt</p>
    <p class="text-xs text-slate-600"><%= @posting_batch.request_id %> · <%= @teller_transaction.posted_at&.strftime("%Y-%m-%d %H:%M:%S") %></p>
  </div>

  <section class="card receipt-section bg-base-100 border border-base-300">
    <div class="card-body">
      <h3 class="card-title text-base">Posting Context</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
        <p><strong>Request ID:</strong> <%= @posting_batch.request_id %></p>
        <p><strong>Transaction Type:</strong> <%= @teller_transaction.transaction_type.titleize %></p>
        <p><strong>Status:</strong> <%= @posting_batch.status %></p>
        <p><strong>Currency:</strong> <%= @posting_batch.currency %></p>
        <p><strong>Posted At:</strong> <%= @teller_transaction.posted_at&.strftime("%Y-%m-%d %H:%M:%S") %></p>
        <p><strong>Committed At:</strong> <%= @posting_batch.committed_at&.strftime("%Y-%m-%d %H:%M:%S") %></p>
        <p><strong>Teller:</strong> <%= @teller_transaction.user.display_label %></p>
        <p><strong>Branch:</strong> <%= @teller_transaction.branch.name %></p>
        <p><strong>Workstation:</strong> <%= @teller_transaction.workstation.name %></p>
        <p><strong>Session ID:</strong> <%= @teller_transaction.teller_session_id %></p>
        <p><strong>Drawer:</strong> <%= @teller_transaction.teller_session.cash_location&.code || "(unassigned)" %></p>
        <p class="md:col-span-2"><strong>Account References:</strong> <span class="font-mono text-xs"><%= @posting_legs.map(&:account_reference).uniq.join(", ") %></span></p>
      </div>
    </div>
  </section>

  <% check_cashing = @posting_batch.metadata.is_a?(Hash) ? (@posting_batch.metadata["check_cashing"] || @posting_batch.metadata[:check_cashing]) : nil %>
  <% vault_transfer = @posting_batch.metadata.is_a?(Hash) ? (@posting_batch.metadata["vault_transfer"] || @posting_batch.metadata[:vault_transfer]) : nil %>
  <% draft = @posting_batch.metadata.is_a?(Hash) ? (@posting_batch.metadata["draft"] || @posting_batch.metadata[:draft]) : nil %>
  <% if check_cashing.present? %>
    <section class="card receipt-section bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Check Cashing Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <% if check_cashing["party_id"].present? %>
            <p class="md:col-span-2"><strong>Party:</strong> <%= Party.find_by(id: check_cashing["party_id"])&.display_name || "ID #{check_cashing["party_id"]}" %></p>
          <% end %>
          <p><strong>Checks Total:</strong> <%= number_to_currency(check_cashing["check_amount_cents"].to_f / 100.0) %></p>
          <p><strong>Fee:</strong> <%= number_to_currency(check_cashing["fee_cents"].to_f / 100.0) %></p>
          <p><strong>Net Cash Payout:</strong> <%= number_to_currency(check_cashing["net_cash_payout_cents"].to_f / 100.0) %></p>
          <p><strong>Fee Account:</strong> <span class="font-mono text-xs"><%= check_cashing["fee_income_account_reference"].presence || "N/A" %></span></p>
          <% if check_cashing["id_type"].present? || check_cashing["id_number"].present? %>
            <p><strong>ID Type:</strong> <%= check_cashing["id_type"].to_s.humanize.presence || "N/A" %></p>
            <p><strong>ID Number:</strong> <%= check_cashing["id_number"].presence || "N/A" %></p>
          <% end %>
        </div>
        <% check_items = Array(check_cashing["check_items"] || check_cashing[:check_items]) %>
        <% if check_items.any? %>
          <div class="mt-3">
            <strong class="text-sm">Checks</strong>
            <table class="table table-sm mt-2 text-sm">
              <thead>
                <tr><th>Routing</th><th>Account</th><th>#</th><th class="text-right">Amount</th></tr>
              </thead>
              <tbody>
                <% check_items.each do |item|
                  item = item.with_indifferent_access if item.respond_to?(:with_indifferent_access)
                %>
                  <tr>
                    <td class="font-mono text-xs"><%= item["routing"].presence || "—" %></td>
                    <td class="font-mono text-xs"><%= item["account"].presence || "—" %></td>
                    <td><%= item["number"].presence || "—" %></td>
                    <td class="text-right tabular-nums"><%= number_to_currency((item["amount_cents"] || 0).to_f / 100.0) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>

  <% if vault_transfer.present? %>
    <section class="card receipt-section bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Vault Transfer Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <p><strong>Direction:</strong> <%= vault_transfer["direction"].to_s.humanize.presence || "N/A" %></p>
          <p><strong>Reason Code:</strong> <%= vault_transfer["reason_code"].to_s.humanize.presence || "N/A" %></p>
          <p><strong>Source:</strong> <span class="font-mono text-xs"><%= vault_transfer["source_cash_account_reference"].presence || "N/A" %></span></p>
          <p><strong>Destination:</strong> <span class="font-mono text-xs"><%= vault_transfer["destination_cash_account_reference"].presence || "N/A" %></span></p>
          <p class="md:col-span-2"><strong>Memo:</strong> <%= vault_transfer["memo"].presence || "N/A" %></p>
        </div>
      </div>
    </section>
  <% end %>

  <% if draft.present? %>
    <section class="card receipt-section bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Draft Issuance Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <p><strong>Funding Source:</strong> <%= draft["funding_source"].to_s.humanize.presence || "N/A" %></p>
          <p><strong>Draft Amount:</strong> <%= number_to_currency(draft["draft_amount_cents"].to_f / 100.0) %></p>
          <p><strong>Fee:</strong> <%= number_to_currency(draft["fee_cents"].to_f / 100.0) %></p>
          <p><strong>Total Funding:</strong> <%= number_to_currency((draft["draft_amount_cents"].to_f + draft["fee_cents"].to_f) / 100.0) %></p>
          <p><strong>Payee:</strong> <%= draft["payee_name"].presence || "N/A" %></p>
          <p><strong>Instrument Number:</strong> <%= draft["instrument_number"].presence || "N/A" %></p>
          <p><strong>Liability Account:</strong> <span class="font-mono text-xs"><%= draft["liability_account_reference"] %></span></p>
          <p><strong>Fee Account:</strong> <span class="font-mono text-xs"><%= draft["fee_income_account_reference"] %></span></p>
        </div>
      </div>
    </section>
  <% end %>

  <section class="card receipt-section bg-base-100 border border-base-300">
    <div class="card-body">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="card-title text-base">Posting Legs</h3>
          <p class="text-xs text-slate-600 mt-1">Ledger entries: debits and credits.</p>
        </div>
      </div>
      <div class="divider my-3"></div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="row-border t-head">
              <th class="py-2 text-left">Pos</th>
              <th class="py-2 text-left">Side</th>
              <th class="py-2 text-left">Account Reference</th>
              <th class="py-2 text-right">Amount</th>
            </tr>
          </thead>
          <tbody>
            <% debit_total_cents = 0 %>
            <% credit_total_cents = 0 %>
            <% @posting_legs.each do |leg| %>
              <% if leg.side == "debit" %>
                <% debit_total_cents += leg.amount_cents %>
              <% else %>
                <% credit_total_cents += leg.amount_cents %>
              <% end %>
              <tr class="row-border">
                <td class="py-2 mono tabular-nums"><%= leg.position %></td>
                <td class="py-2"><span class="badge badge-outline"><%= leg.side %></span></td>
                <td class="py-2 mono text-xs"><%= leg.account_reference %></td>
                <td class="py-2 text-right mono tabular-nums ui-money"><%= number_to_currency(leg.amount_cents.to_f / 100.0) %></td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr class="row-border">
              <th colspan="3" class="py-2 text-right text-xs font-medium text-slate-600">Debits</th>
              <th class="py-2 text-right mono tabular-nums"><%= number_to_currency(debit_total_cents.to_f / 100.0) %></th>
            </tr>
            <tr class="row-border">
              <th colspan="3" class="py-2 text-right text-xs font-medium text-slate-600">Credits</th>
              <th class="py-2 text-right mono tabular-nums"><%= number_to_currency(credit_total_cents.to_f / 100.0) %></th>
            </tr>
            <tr class="row-border">
              <th colspan="3" class="py-2 text-right text-xs font-medium text-slate-600">Balance Delta</th>
              <th class="py-2 text-right mono tabular-nums"><%= number_to_currency((debit_total_cents - credit_total_cents).abs.to_f / 100.0) %></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <% if @cash_movements.any? %>
    <section class="card receipt-section bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Cash Movement</h3>
        <% @cash_movements.each do |movement| %>
          <p class="text-sm">
            <strong><%= movement.direction.titleize %></strong>
            <span class="font-mono text-xs"><%= movement.cash_location&.code || "(no location)" %></span>
            — <%= number_to_currency(movement.amount_cents.to_f / 100.0) %>
          </p>
        <% end %>
      </div>
    </section>
  <% end %>
</div>

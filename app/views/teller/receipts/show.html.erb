<div class="space-y-4">
  <%= render "teller/shared/page_header",
    title: "Receipt / Audit",
    description: "Posted transaction details (immutable)",
    secondary_button_path: teller_root_path,
    secondary_button_label: "Back to Dashboard" %>

  <section class="card bg-base-100 border border-base-300">
    <div class="card-body">
      <h3 class="card-title text-base">Posting Context</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
        <p><strong>Request ID:</strong> <%= @posting_batch.request_id %></p>
        <p><strong>Transaction Type:</strong> <%= @teller_transaction.transaction_type.titleize %></p>
        <p><strong>Status:</strong> <%= @posting_batch.status %></p>
        <p><strong>Currency:</strong> <%= @posting_batch.currency %></p>
        <p><strong>Posted At:</strong> <%= @teller_transaction.posted_at&.strftime("%Y-%m-%d %H:%M:%S") %></p>
        <p><strong>Committed At:</strong> <%= @posting_batch.committed_at&.strftime("%Y-%m-%d %H:%M:%S") %></p>
        <p><strong>Teller:</strong> <%= @teller_transaction.user.email_address %></p>
        <p><strong>Branch:</strong> <%= @teller_transaction.branch.name %></p>
        <p><strong>Workstation:</strong> <%= @teller_transaction.workstation.name %></p>
        <p><strong>Session ID:</strong> <%= @teller_transaction.teller_session_id %></p>
        <p><strong>Drawer:</strong> <%= @teller_transaction.teller_session.cash_location&.code || "(unassigned)" %></p>
        <p class="md:col-span-2"><strong>Account References:</strong> <span class="font-mono text-xs"><%= @posting_legs.map(&:account_reference).uniq.join(", ") %></span></p>
      </div>
    </div>
  </section>

  <% check_cashing = @posting_batch.metadata.is_a?(Hash) ? (@posting_batch.metadata["check_cashing"] || @posting_batch.metadata[:check_cashing]) : nil %>
  <% if check_cashing.present? %>
    <section class="card bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Check Cashing Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <p><strong>Check Amount:</strong> <%= number_to_currency(check_cashing["check_amount_cents"].to_f / 100.0) %></p>
          <p><strong>Fee:</strong> <%= number_to_currency(check_cashing["fee_cents"].to_f / 100.0) %></p>
          <p><strong>Net Cash Payout:</strong> <%= number_to_currency(check_cashing["net_cash_payout_cents"].to_f / 100.0) %></p>
          <p><strong>Settlement Account:</strong> <span class="font-mono text-xs"><%= check_cashing["settlement_account_reference"] %></span></p>
          <p><strong>Fee Account:</strong> <span class="font-mono text-xs"><%= check_cashing["fee_income_account_reference"] %></span></p>
          <p><strong>Check Number:</strong> <%= check_cashing["check_number"].presence || "N/A" %></p>
          <p><strong>Routing Number:</strong> <%= check_cashing["routing_number"].presence || "N/A" %></p>
          <p><strong>Account Number:</strong> <%= check_cashing["account_number"].presence || "N/A" %></p>
          <p><strong>Payer Name:</strong> <%= check_cashing["payer_name"].presence || "N/A" %></p>
          <p><strong>Presenter Type:</strong> <%= check_cashing["presenter_type"].to_s.humanize.presence || "N/A" %></p>
          <p><strong>ID Type:</strong> <%= check_cashing["id_type"].to_s.humanize.presence || "N/A" %></p>
          <p><strong>ID Number:</strong> <%= check_cashing["id_number"].presence || "N/A" %></p>
        </div>
      </div>
    </section>
  <% end %>

  <section class="card bg-base-100 border border-base-300">
    <div class="card-body">
      <h3 class="card-title text-base">Posting Legs</h3>

      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Pos</th>
              <th>Side</th>
              <th>Account Reference</th>
              <th class="text-right">Amount</th>
            </tr>
          </thead>
          <tbody>
            <% debit_total_cents = 0 %>
            <% credit_total_cents = 0 %>
            <% @posting_legs.each do |leg| %>
              <% if leg.side == "debit" %>
                <% debit_total_cents += leg.amount_cents %>
              <% else %>
                <% credit_total_cents += leg.amount_cents %>
              <% end %>
              <tr>
                <td><%= leg.position %></td>
                <td><span class="badge badge-outline"><%= leg.side %></span></td>
                <td class="font-mono text-xs"><%= leg.account_reference %></td>
                <td class="text-right"><%= number_to_currency(leg.amount_cents.to_f / 100.0) %></td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-right">Debits</th>
              <th class="text-right"><%= number_to_currency(debit_total_cents.to_f / 100.0) %></th>
            </tr>
            <tr>
              <th colspan="3" class="text-right">Credits</th>
              <th class="text-right"><%= number_to_currency(credit_total_cents.to_f / 100.0) %></th>
            </tr>
            <tr>
              <th colspan="3" class="text-right">Balance Delta</th>
              <th class="text-right"><%= number_to_currency(((debit_total_cents - credit_total_cents).abs).to_f / 100.0) %></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <% if @cash_movements.any? %>
    <section class="card bg-base-100 border border-base-300">
      <div class="card-body">
        <h3 class="card-title text-base">Cash Movement</h3>
        <% @cash_movements.each do |movement| %>
          <p class="text-sm">
            <strong><%= movement.direction.titleize %></strong>
            <span class="font-mono text-xs"><%= movement.cash_location&.code || "(no location)" %></span>
            â€” <%= number_to_currency(movement.amount_cents.to_f / 100.0) %>
          </p>
        <% end %>
      </div>
    </section>
  <% end %>
</div>

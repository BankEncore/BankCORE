<% form = local_assigns.fetch(:form) %>
<% selected_party = local_assigns[:selected_party] %>
<% cash_account_reference_value = local_assigns.fetch(:cash_account_reference_value, "") %>
<% wfc = local_assigns.fetch(:workflow_form_controller, "check-cashing-form") %>

<%= hidden_field_tag :transaction_type, "check_cashing", data: { "#{wfc}_target": "transactionType" } %>

<%= form.hidden_field :amount_cents, value: 0, data: { "#{wfc}_target": "amountCents" } %>
<%= form.hidden_field :cash_account_reference,
  value: cash_account_reference_value,
  data: { "#{wfc}_target": "cashAccountReference" } %>

<section data-<%= wfc %>-target="checkCashingSection">
  <div class="font-medium">Check Cashing Details</div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
    <div class="form-control" data-controller="party-search" data-party-search-search-url-value="<%= search_teller_parties_path %>">
      <%= form.label :party_id, "Party", class: "text-xs font-medium text-slate-700 block" %>
      <div class="relative">
        <%= form.hidden_field :party_id, value: params[:party_id], data: { "#{wfc}_target": "partyId", party_search_target: "hiddenInput" } %>
        <input type="text"
          class="input input-bordered w-full"
          placeholder="Search by name or phone"
          autocomplete="off"
          data-party-search-target="searchInput"
          data-action="input->party-search#search"
          value="<%= selected_party&.display_name || "" %>" />
        <div data-party-search-target="resultsList"
          class="absolute left-0 right-0 z-50 mt-1 w-full max-h-48 overflow-auto rounded bg-base-100 border border-base-300 shadow"
          hidden>
        </div>
      </div>
      <span class="text-xs text-slate-600 mt-1 block">Individual presenting the check(s).</span>
      <%= link_to "Add new party", new_teller_party_path(party_kind: "individual", return_to: request.original_url), class: "link link-hover text-xs mt-1 inline-block" %>
    </div>
    <div class="form-control">
      <%= form.label :fee_cents, "Fee", class: "text-xs font-medium text-slate-700 block" %>
      <div data-controller="currency-input" data-action="input-><%= wfc %>#recalculate">
        <%= form.hidden_field :fee_cents, value: 0, data: { "#{wfc}_target": "feeCents", currency_input_target: "hiddenInput" } %>
        <input type="text" class="input input-bordered w-full" inputmode="decimal" placeholder="$0.00" aria-label="Fee" data-currency-input-target="displayInput" data-action="input->currency-input#input blur->currency-input#blur" id="<%= form.field_id(:fee_cents) %>" />
      </div>
      <span class="text-xs text-slate-600 mt-1 block">Optional fee withheld from payout.</span>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3" data-<%= wfc %>-target="checkCashingIdRow">
    <p class="form-control">
      <%= form.label :id_type, "ID Type", class: "text-xs font-medium text-slate-700" %><br>
      <%= form.select :id_type,
        options_for_select([["Driver's License", "drivers_license"], ["Passport", "passport"], ["State ID", "state_id"], ["Other", "other"]], ""),
        { include_blank: "Select type" },
        { data: { "#{wfc}_target": "idType", action: "change->#{wfc}#recalculate" }, class: "select select-bordered w-full" } %>
    </p>
    <p class="form-control">
      <%= form.label :id_number, "ID Number", class: "text-xs font-medium text-slate-700" %><br>
      <%= form.text_field :id_number, data: { "#{wfc}_target": "idNumber", action: "input->#{wfc}#recalculate" }, class: "input input-bordered", placeholder: "Required when no party selected" %>
    </p>
  </div>

  <%= form.hidden_field :fee_income_account_reference,
    value: "income:check_cashing_fee",
    data: { "#{wfc}_target": "feeIncomeAccountReference" } %>
</section>

<%= render "teller/forms/check_section", workflow_form_controller: wfc %>

<%= render "teller/forms/computed_totals", show_cash_back: false, workflow_form_controller: wfc %>
